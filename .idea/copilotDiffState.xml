<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/app/api/fiches-horaires/[id]/route.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/app/api/fiches-horaires/[id]/route.js" />
              <option name="originalContent" value="import { NextResponse } from 'next/server';&#10;import mysql from 'mysql2/promise';&#10;&#10;const dbConfig = {&#10;  host: process.env.MYSQL_HOST || 'localhost',&#10;  user: process.env.MYSQL_USER || 'root',&#10;  password: process.env.MYSQL_PASSWORD || '',&#10;  database: 'horaires',&#10;  charset: 'utf8mb4'&#10;};&#10;&#10;async function getConnection() {&#10;  return await mysql.createConnection(dbConfig);&#10;}&#10;&#10;// GET - Récupérer une fiche horaire spécifique&#10;export async function GET(request, { params }) {&#10;  let connection;&#10;  try {&#10;    const { id } = await params;&#10;    connection = await getConnection();&#10;&#10;    const [fiches] = await connection.execute(&#10;      `SELECT &#10;        fh.*,&#10;        sa.nom as service_annuel_nom,&#10;        sa.date_debut as service_date_debut,&#10;        sa.date_fin as service_date_fin&#10;       FROM fiches_horaires fh&#10;       LEFT JOIN services_annuels sa ON fh.service_annuel_id = sa.id&#10;       WHERE fh.id = ?`,&#10;      [id]&#10;    );&#10;&#10;    if (fiches.length === 0) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Fiche horaire non trouvée'&#10;      }, { status: 404 });&#10;    }&#10;&#10;    return NextResponse.json({&#10;      success: true,&#10;      fiche: fiches[0]&#10;    });&#10;  } catch (error) {&#10;    console.error('Erreur GET fiche horaire:', error);&#10;    return NextResponse.json({&#10;      success: false,&#10;      message: 'Erreur lors de la récupération de la fiche horaire'&#10;    }, { status: 500 });&#10;  } finally {&#10;    if (connection) await connection.end();&#10;  }&#10;}&#10;&#10;// PUT - Modifier une fiche horaire&#10;export async function PUT(request, { params }) {&#10;  let connection;&#10;  try {&#10;    const { id } = await params;&#10;    const body = await request.json();&#10;    const {&#10;      nom,&#10;      service_annuel_id,&#10;      type_fiche,&#10;      design_region,&#10;      ligne_id,&#10;      afficher_page_recherche&#10;    } = body;&#10;&#10;    // Validation&#10;    if (!nom || !service_annuel_id || !type_fiche || !design_region) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Tous les champs obligatoires doivent être remplis'&#10;      }, { status: 400 });&#10;    }&#10;&#10;    connection = await getConnection();&#10;&#10;    const [result] = await connection.execute(&#10;      `UPDATE fiches_horaires &#10;       SET nom = ?, &#10;           service_annuel_id = ?, &#10;           type_fiche = ?, &#10;           design_region = ?, &#10;           ligne_id = ?, &#10;           afficher_page_recherche = ?&#10;       WHERE id = ?`,&#10;      [&#10;        nom,&#10;        service_annuel_id,&#10;        type_fiche,&#10;        design_region,&#10;        (ligne_id &amp;&amp; ligne_id !== '') ? ligne_id : null,&#10;        afficher_page_recherche ? 1 : 0,&#10;        id&#10;      ]&#10;    );&#10;&#10;    if (result.affectedRows === 0) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Fiche horaire non trouvée'&#10;      }, { status: 404 });&#10;    }&#10;&#10;    return NextResponse.json({&#10;      success: true,&#10;      message: 'Fiche horaire modifiée avec succès'&#10;    });&#10;  } catch (error) {&#10;    console.error('Erreur PUT fiche horaire:', error);&#10;    return NextResponse.json({&#10;      success: false,&#10;      message: 'Erreur lors de la modification de la fiche horaire'&#10;    }, { status: 500 });&#10;  } finally {&#10;    if (connection) await connection.end();&#10;  }&#10;}&#10;&#10;// DELETE - Supprimer une fiche horaire&#10;export async function DELETE(request, { params }) {&#10;  let connection;&#10;  try {&#10;    const { id } = await params;&#10;    connection = await getConnection();&#10;&#10;    // Récupérer le chemin du PDF pour le supprimer&#10;    const [fiches] = await connection.execute(&#10;      'SELECT pdf_path FROM fiches_horaires WHERE id = ?',&#10;      [id]&#10;    );&#10;&#10;    const [result] = await connection.execute(&#10;      'DELETE FROM fiches_horaires WHERE id = ?',&#10;      [id]&#10;    );&#10;&#10;    if (result.affectedRows === 0) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Fiche horaire non trouvée'&#10;      }, { status: 404 });&#10;    }&#10;&#10;    // TODO: Supprimer le fichier PDF du système de fichiers si nécessaire&#10;    // const fs = require('fs').promises;&#10;    // if (fiches[0]?.pdf_path) {&#10;    //   await fs.unlink(path.join(process.cwd(), 'public', fiches[0].pdf_path));&#10;    // }&#10;&#10;    return NextResponse.json({&#10;      success: true,&#10;      message: 'Fiche horaire supprimée avec succès'&#10;    });&#10;  } catch (error) {&#10;    console.error('Erreur DELETE fiche horaire:', error);&#10;    return NextResponse.json({&#10;      success: false,&#10;      message: 'Erreur lors de la suppression de la fiche horaire'&#10;    }, { status: 500 });&#10;  } finally {&#10;    if (connection) await connection.end();&#10;  }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="import { NextResponse } from 'next/server';&#10;import mysql from 'mysql2/promise';&#10;&#10;const dbConfig = {&#10;  host: process.env.MYSQL_HOST || 'localhost',&#10;  user: process.env.MYSQL_USER || 'root',&#10;  password: process.env.MYSQL_PASSWORD || '',&#10;  database: 'horaires',&#10;  charset: 'utf8mb4'&#10;};&#10;&#10;async function getConnection() {&#10;  return await mysql.createConnection(dbConfig);&#10;}&#10;&#10;// GET - Récupérer une fiche horaire spécifique&#10;export async function GET(request, { params }) {&#10;  let connection;&#10;  try {&#10;    const { id } = await params;&#10;    connection = await getConnection();&#10;&#10;    const [fiches] = await connection.execute(&#10;      `SELECT &#10;        fh.*,&#10;        sa.nom as service_annuel_nom,&#10;        sa.date_debut as service_date_debut,&#10;        sa.date_fin as service_date_fin&#10;       FROM fiches_horaires fh&#10;       LEFT JOIN services_annuels sa ON fh.service_annuel_id = sa.id&#10;       WHERE fh.id = ?`,&#10;      [id]&#10;    );&#10;&#10;    if (fiches.length === 0) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Fiche horaire non trouvée'&#10;      }, { status: 404 });&#10;    }&#10;&#10;    return NextResponse.json({&#10;      success: true,&#10;      fiche: fiches[0]&#10;    });&#10;  } catch (error) {&#10;    console.error('Erreur GET fiche horaire:', error);&#10;    return NextResponse.json({&#10;      success: false,&#10;      message: 'Erreur lors de la récupération de la fiche horaire'&#10;    }, { status: 500 });&#10;  } finally {&#10;    if (connection) await connection.end();&#10;  }&#10;}&#10;&#10;// PUT - Modifier une fiche horaire&#10;export async function PUT(request, { params }) {&#10;  let connection;&#10;  try {&#10;    const { id } = await params;&#10;    const body = await request.json();&#10;    const {&#10;      nom,&#10;      service_annuel_id,&#10;      type_fiche,&#10;      design_region,&#10;      ligne_id,&#10;      afficher_page_recherche&#10;    } = body;&#10;&#10;    // Validation&#10;    if (!nom || !service_annuel_id || !type_fiche || !design_region) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Tous les champs obligatoires doivent être remplis'&#10;      }, { status: 400 });&#10;    }&#10;&#10;    connection = await getConnection();&#10;&#10;    const [result] = await connection.execute(&#10;      `UPDATE fiches_horaires &#10;       SET nom = ?, &#10;           service_annuel_id = ?, &#10;           type_fiche = ?, &#10;           design_region = ?, &#10;           ligne_id = ?, &#10;           afficher_page_recherche = ?&#10;       WHERE id = ?`,&#10;      [&#10;        nom,&#10;        service_annuel_id,&#10;        type_fiche,&#10;        design_region,&#10;        (ligne_id &amp;&amp; ligne_id !== '') ? ligne_id : null,&#10;        afficher_page_recherche ? 1 : 0,&#10;        id&#10;      ]&#10;    );&#10;&#10;    if (result.affectedRows === 0) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Fiche horaire non trouvée'&#10;      }, { status: 404 });&#10;    }&#10;&#10;    return NextResponse.json({&#10;      success: true,&#10;      message: 'Fiche horaire modifiée avec succès'&#10;    });&#10;  } catch (error) {&#10;    console.error('Erreur PUT fiche horaire:', error);&#10;    return NextResponse.json({&#10;      success: false,&#10;      message: 'Erreur lors de la modification de la fiche horaire'&#10;    }, { status: 500 });&#10;  } finally {&#10;    if (connection) await connection.end();&#10;  }&#10;}&#10;&#10;// DELETE - Supprimer une fiche horaire&#10;export async function DELETE(request, { params }) {&#10;  let connection;&#10;  try {&#10;    const { id } = await params;&#10;    connection = await getConnection();&#10;&#10;    // Récupérer le chemin du PDF pour le supprimer&#10;    const [fiches] = await connection.execute(&#10;      'SELECT pdf_path FROM fiches_horaires WHERE id = ?',&#10;      [id]&#10;    );&#10;&#10;    const [result] = await connection.execute(&#10;      'DELETE FROM fiches_horaires WHERE id = ?',&#10;      [id]&#10;    );&#10;&#10;    if (result.affectedRows === 0) {&#10;      return NextResponse.json({&#10;        success: false,&#10;        message: 'Fiche horaire non trouvée'&#10;      }, { status: 404 });&#10;    }&#10;&#10;    // TODO: Supprimer le fichier PDF du système de fichiers si nécessaire&#10;    // const fs = require('fs').promises;&#10;    // if (fiches[0]?.pdf_path) {&#10;    //   await fs.unlink(path.join(process.cwd(), 'public', fiches[0].pdf_path));&#10;    // }&#10;&#10;    return NextResponse.json({&#10;      success: true,&#10;      message: 'Fiche horaire supprimée avec succès'&#10;    });&#10;  } catch (error) {&#10;    console.error('Erreur DELETE fiche horaire:', error);&#10;    return NextResponse.json({&#10;      success: false,&#10;      message: 'Erreur lors de la suppression de la fiche horaire'&#10;    }, { status: 500 });&#10;  } finally {&#10;    if (connection) await connection.end();&#10;  }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>